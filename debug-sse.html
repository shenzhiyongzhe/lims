<!DOCTYPE html>
<html>

<head>
  <title>SSE Debug Tool</title>
</head>

<body>
  <h1>SSE Connection Debug</h1>
  <div id="status">Connecting...</div>
  <div id="messages"></div>
  <div id="errors"></div>

  <script>
    const status = document.getElementById('status');
    const messages = document.getElementById('messages');
    const errors = document.getElementById('errors');

    function log(message) {
      console.log(message);
      messages.innerHTML += '<div>' + JSON.stringify(message) + '</div>';
    }

    function logError(error) {
      console.error(error);
      errors.innerHTML += '<div style="color: red;">' + JSON.stringify(error) + '</div>';
    }

    // 测试不同的后端地址
    const backends = [
      'http://localhost:3001',  // NestJS default
      'http://localhost:3000',  // Next.js default
      'http://localhost:8000',  // Alternative port
    ];

    let currentBackend = 0;

    function testConnection() {
      const baseUrl = backends[currentBackend];
      const url = `${baseUrl}/events?type=payee`;

      log(`Testing connection to: ${url}`);
      status.textContent = `Testing ${baseUrl}...`;

      try {
        const eventSource = new EventSource(url, {
          withCredentials: true
        });

        eventSource.onopen = function (event) {
          log('SSE Connected successfully!');
          log({ event, readyState: eventSource.readyState });
          status.textContent = `Connected to ${baseUrl}`;
        };

        eventSource.onmessage = function (event) {
          log('SSE Message received:');
          log(JSON.parse(event.data));
        };

        eventSource.onerror = function (error) {
          logError('SSE Error:');
          logError({
            error,
            readyState: eventSource.readyState,
            url: eventSource.url
          });

          eventSource.close();

          // Try next backend
          currentBackend++;
          if (currentBackend < backends.length) {
            setTimeout(testConnection, 1000);
          } else {
            status.textContent = 'All backends failed';
          }
        };

      } catch (error) {
        logError('Failed to create EventSource:');
        logError(error);

        // Try next backend
        currentBackend++;
        if (currentBackend < backends.length) {
          setTimeout(testConnection, 1000);
        } else {
          status.textContent = 'All backends failed';
        }
      }
    }

    // Start testing
    testConnection();
  </script>
</body>

</html>