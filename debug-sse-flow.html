<!DOCTYPE html>
<html>

<head>
  <title>SSE Flow Debug Tool</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }

    .section {
      margin: 20px 0;
      padding: 15px;
      border: 1px solid #ccc;
      border-radius: 5px;
    }

    .success {
      background-color: #d4edda;
      border-color: #c3e6cb;
    }

    .error {
      background-color: #f8d7da;
      border-color: #f5c6cb;
    }

    .info {
      background-color: #d1ecf1;
      border-color: #bee5eb;
    }

    button {
      padding: 10px 15px;
      margin: 5px;
      cursor: pointer;
    }

    pre {
      background: #f8f9fa;
      padding: 10px;
      border-radius: 3px;
      overflow-x: auto;
    }
  </style>
</head>

<body>
  <h1>SSE Flow Debug Tool</h1>

  <div class="section info">
    <h3>1. æ£€æŸ¥localStorageä¸­çš„adminæ•°æ®</h3>
    <button onclick="checkAdminData()">æ£€æŸ¥Adminæ•°æ®</button>
    <div id="adminData"></div>
  </div>

  <div class="section info">
    <h3>2. æµ‹è¯•Payee SSEè¿æ¥</h3>
    <button onclick="testPayeeSSE()">è¿æ¥Payee SSE</button>
    <div id="payeeSSE"></div>
  </div>

  <div class="section info">
    <h3>3. æµ‹è¯•è®¢å•æäº¤</h3>
    <button onclick="testSubmitOrder()">æäº¤æµ‹è¯•è®¢å•</button>
    <div id="submitOrder"></div>
  </div>

  <div class="section info">
    <h3>4. æ£€æŸ¥NestJSæœåŠ¡å™¨çŠ¶æ€</h3>
    <button onclick="checkNestJSStatus()">æ£€æŸ¥æœåŠ¡å™¨</button>
    <div id="nestJSStatus"></div>
  </div>

  <div class="section">
    <h3>è°ƒè¯•æ—¥å¿—</h3>
    <div id="logs"></div>
  </div>

  <script>
    const BASE_URL = 'http://localhost:3000';
    let payeeEventSource = null;

    function log(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString();
      const logDiv = document.getElementById('logs');
      const color = type === 'error' ? 'red' : type === 'success' ? 'green' : 'black';
      logDiv.innerHTML += `<div style="color: ${color}">[${timestamp}] ${message}</div>`;
      console.log(`[${timestamp}] ${message}`);
    }

    function checkAdminData() {
      const adminData = localStorage.getItem('admin');
      const div = document.getElementById('adminData');

      if (!adminData) {
        div.innerHTML = '<div class="error">âŒ æ²¡æœ‰æ‰¾åˆ°adminæ•°æ®</div>';
        log('âŒ æ²¡æœ‰æ‰¾åˆ°adminæ•°æ®', 'error');
        return;
      }

      try {
        const admin = JSON.parse(adminData);
        div.innerHTML = `
                    <div class="success">âœ… Adminæ•°æ®å­˜åœ¨</div>
                    <pre>${JSON.stringify(admin, null, 2)}</pre>
                `;
        log(`âœ… Adminæ•°æ®: ${JSON.stringify(admin)}`, 'success');
      } catch (error) {
        div.innerHTML = '<div class="error">âŒ Adminæ•°æ®æ ¼å¼é”™è¯¯</div>';
        log(`âŒ Adminæ•°æ®è§£æé”™è¯¯: ${error.message}`, 'error');
      }
    }

    function testPayeeSSE() {
      const adminData = localStorage.getItem('admin');
      if (!adminData) {
        document.getElementById('payeeSSE').innerHTML = '<div class="error">âŒ è¯·å…ˆæ£€æŸ¥Adminæ•°æ®</div>';
        return;
      }

      try {
        const admin = JSON.parse(adminData);
        const url = `${BASE_URL}/events?type=payee&admin_id=${admin.id}`;

        log(`ğŸ”— è¿æ¥Payee SSE: ${url}`);

        if (payeeEventSource) {
          payeeEventSource.close();
        }

        payeeEventSource = new EventSource(url);

        payeeEventSource.onopen = function (event) {
          document.getElementById('payeeSSE').innerHTML = '<div class="success">âœ… Payee SSEè¿æ¥æˆåŠŸ</div>';
          log('âœ… Payee SSEè¿æ¥æˆåŠŸ', 'success');
        };

        payeeEventSource.onmessage = function (event) {
          const message = JSON.parse(event.data);
          log(`ğŸ“¨ æ”¶åˆ°æ¶ˆæ¯: ${JSON.stringify(message)}`, 'info');

          if (message.type === 'connected') {
            document.getElementById('payeeSSE').innerHTML += '<div class="success">âœ… æ”¶åˆ°è¿æ¥ç¡®è®¤æ¶ˆæ¯</div>';
          } else if (message.type === 'new_order') {
            document.getElementById('payeeSSE').innerHTML += '<div class="success">ğŸ‰ æ”¶åˆ°æ–°è®¢å•é€šçŸ¥!</div>';
          }
        };

        payeeEventSource.onerror = function (error) {
          document.getElementById('payeeSSE').innerHTML = '<div class="error">âŒ Payee SSEè¿æ¥å¤±è´¥</div>';
          log(`âŒ Payee SSEè¿æ¥å¤±è´¥: ${JSON.stringify(error)}`, 'error');
        };

      } catch (error) {
        document.getElementById('payeeSSE').innerHTML = '<div class="error">âŒ åˆ›å»ºSSEè¿æ¥å¤±è´¥</div>';
        log(`âŒ åˆ›å»ºSSEè¿æ¥å¤±è´¥: ${error.message}`, 'error');
      }
    }

    function testSubmitOrder() {
      const testOrder = {
        type: "submit_order",
        data: {
          id: "test-order-" + Date.now(),
          share_id: "test-share",
          customer_id: 1,
          customer: {
            username: "æµ‹è¯•ç”¨æˆ·",
            phone: "12345678901",
            address: "æµ‹è¯•åœ°å€"
          },
          amount: "100",
          payment_method: "wechat_pay",
          remark: "æµ‹è¯•è®¢å•",
          loan_id: 1,
          payment_periods: 1
        }
      };

      log(`ğŸ“¤ æäº¤æµ‹è¯•è®¢å•: ${JSON.stringify(testOrder)}`);

      fetch(`${BASE_URL}/events`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(testOrder)
      })
        .then(response => response.json())
        .then(data => {
          document.getElementById('submitOrder').innerHTML = `
                    <div class="success">âœ… è®¢å•æäº¤æˆåŠŸ</div>
                    <pre>${JSON.stringify(data, null, 2)}</pre>
                `;
          log(`âœ… è®¢å•æäº¤æˆåŠŸ: ${JSON.stringify(data)}`, 'success');
        })
        .catch(error => {
          document.getElementById('submitOrder').innerHTML = `
                    <div class="error">âŒ è®¢å•æäº¤å¤±è´¥</div>
                    <pre>${error.message}</pre>
                `;
          log(`âŒ è®¢å•æäº¤å¤±è´¥: ${error.message}`, 'error');
        });
    }

    function checkNestJSStatus() {
      fetch(`${BASE_URL}/events?type=payee&admin_id=1`, { method: 'HEAD' })
        .then(response => {
          document.getElementById('nestJSStatus').innerHTML = `
                    <div class="success">âœ… NestJSæœåŠ¡å™¨å“åº”æ­£å¸¸</div>
                    <div>çŠ¶æ€ç : ${response.status}</div>
                    <div>å“åº”å¤´: ${JSON.stringify(Object.fromEntries(response.headers.entries()))}</div>
                `;
          log(`âœ… NestJSæœåŠ¡å™¨çŠ¶æ€: ${response.status}`, 'success');
        })
        .catch(error => {
          document.getElementById('nestJSStatus').innerHTML = `
                    <div class="error">âŒ NestJSæœåŠ¡å™¨æ— å“åº”</div>
                    <div>é”™è¯¯: ${error.message}</div>
                `;
          log(`âŒ NestJSæœåŠ¡å™¨æ— å“åº”: ${error.message}`, 'error');
        });
    }

    // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥
    window.onload = function () {
      checkAdminData();
      checkNestJSStatus();
    };
  </script>
</body>

</html>